{% extends "base.html" %}

{% block title %}Fetch Orders - COD Verifier{% endblock %}

{% block content %}
<h1 class="text-3xl font-bold mb-8">üì• Fetch Orders</h1>

<div class="grid grid-cols-2 gap-6">
    <!-- Shopify COD Orders -->
    <div class="bg-white rounded-lg shadow p-6">
        <h2 class="text-2xl font-bold mb-4">Shopify COD Orders</h2>
        <p class="text-gray-600 mb-4">Fetch unfulfilled COD orders from all 3 stores</p>
        
        <div class="mb-4">
            <label class="block text-sm font-medium mb-2">Days to fetch</label>
            <select id="shopifyDays" class="w-full border rounded px-3 py-2">
                <option value="1">Last 1 day</option>
                <option value="3">Last 3 days</option>
                <option value="7">Last 7 days</option>
                <option value="10" selected>Last 10 days</option>
                <option value="14">Last 14 days</option>
                <option value="30">Last 30 days</option>
            </select>
        </div>
        
        <button onclick="fetchShopify()" 
                class="w-full bg-blue-600 text-white font-bold py-3 rounded-lg hover:bg-blue-700">
            Fetch from Shopify
        </button>
        
        <div id="shopifyResult" class="mt-4 hidden"></div>
    </div>
    
    <!-- Shiprocket Abandoned Carts -->
    <div class="bg-white rounded-lg shadow p-6">
        <h2 class="text-2xl font-bold mb-4">Abandoned Carts (Shiprocket)</h2>
        <p class="text-gray-600 mb-4">Fetch abandoned cart checkouts</p>
        
        <div class="mb-4">
            <label class="block text-sm font-medium mb-2">Start Date</label>
            <input type="date" id="shiprocketStart" class="w-full border rounded px-3 py-2">
        </div>
        
        <div class="mb-4">
            <label class="block text-sm font-medium mb-2">End Date</label>
            <input type="date" id="shiprocketEnd" class="w-full border rounded px-3 py-2">
        </div>
        
        <button onclick="fetchShiprocket()" 
                class="w-full bg-purple-600 text-white font-bold py-3 rounded-lg hover:bg-purple-700">
            Fetch Abandoned Carts
        </button>
        
        <div id="shiprocketResult" class="mt-4 hidden"></div>
    </div>
</div>

<script>
async function fetchShopify() {
    const days = document.getElementById('shopifyDays').value;
    const resultDiv = document.getElementById('shopifyResult');
    
    resultDiv.innerHTML = '<p class="text-blue-600">‚è≥ Fetching orders...</p>';
    resultDiv.classList.remove('hidden');
    
    const response = await fetch('/fetch-orders', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({source: 'shopify', days: parseInt(days)})
    });
    
    const data = await response.json();
    
    if (response.ok) {
        resultDiv.innerHTML = `
            <div class="bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded">
                ‚úÖ Success!<br>
                Total fetched: ${data.total_fetched}<br>
                New orders: ${data.new_orders}<br>
                Orders distributed to callers
            </div>
        `;
    } else {
        resultDiv.innerHTML = `
            <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded">
                ‚ùå Error: ${data.error || 'Failed to fetch orders'}
            </div>
        `;
    }
}

async function fetchShiprocket() {
    const resultDiv = document.getElementById('shiprocketResult');
    
    resultDiv.innerHTML = `
        <div class="bg-yellow-100 border border-yellow-400 text-yellow-700 px-4 py-3 rounded">
            ‚ö†Ô∏è Coming soon! Shiprocket integration in Phase 2
        </div>
    `;
    resultDiv.classList.remove('hidden');
}

// Set default dates
document.getElementById('shiprocketStart').valueAsDate = new Date(Date.now() - 7 * 24 * 60 * 60 * 1000);
document.getElementById('shiprocketEnd').valueAsDate = new Date();
</script>
{% endblock %}
